<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
<meta http-equiv="content-language" content="en">
<meta name="format-detection" content="telephone=no">
    <title>Global Lotto Strategy - Pyramidal Algorithm Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#030712">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <style>
        /* Estilos base para el fondo y la fuente */
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #030712; /* gray-950 */
        }
        /* Ocultar pantallas no activas */
        .screen:not(.active) {
            display: none;
        }
        /* Iconos de Lucide (usamos SVG o im√°genes si no estamos en React, pero por simplicidad se usa texto/emojis como placeholder) */
        .icon-globe::before { content: "üåç"; margin-right: 0.5rem; }
        .icon-right::before { content: "‚Üí"; }
        .icon-left::before { content: "‚Üê"; }
        .icon-dice::before { content: "üé≤"; margin-right: 0.5rem; }
        .icon-calc::before { content: "üßÆ"; margin-right: 0.5rem; }
        .icon-check::before { content: "‚úÖ"; margin-right: 0.5rem; }
        .icon-error::before { content: "‚ùå"; margin-right: 0.5rem; }
        .icon-export::before { content: "üìÑ"; margin-right: 0.5rem; }
        .icon-star::before { content: "‚≠ê"; margin-right: 0.5rem; }
        .icon-magic::before { content: "‚ú®"; margin-right: 0.5rem; }
        .icon-sim::before { content: "üìä"; margin-right: 0.5rem; }
        .icon-money::before { content: "üí∞"; margin-right: 0.5rem; }

        /* Estilos de bandera */
        .flag-icon {
            font-size: 2.5rem; /* Ajuste el tama√±o de la bandera */
            line-height: 1; /* Asegura que el emoji no tenga espacio extra */
        }
        
        /* Estilo para los n√∫meros base seleccionados (Generaci√≥n) */
        .selected-number-display {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f59e0b; /* amber-500 */
            color: #111827; /* gray-900 */
            font-weight: bold;
            margin: 4px;
            transition: all 0.2s;
        }

        /* Estilo para los botones de la cuadr√≠cula de n√∫meros principales (Generaci√≥n) */
        .grid-number-button {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.15s;
            background-color: #1f2937; /* gray-800 */
            color: #fff;
            border: 1px solid #374151; /* gray-700 */
            cursor: pointer;
        }
        .grid-number-button.selected {
            background-color: #f59e0b; /* amber-500 */
            color: #111827; /* gray-900 */
            border-color: #f59e0b;
            transform: scale(1.1);
        }
        .grid-number-button:hover:not(.selected):not([disabled]) {
            background-color: #4b5563; /* gray-600 */
        }
        .grid-number-button[disabled] {
            cursor: not-allowed;
            opacity: 0.4;
        }

        /* Estilo para los botones de la cuadr√≠cula de n√∫meros EXTRA (Generaci√≥n) */
        .grid-extra-number-button {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.15s;
            background-color: #dc2626; /* red-600 */
            color: #fff;
            border: 1px solid #ef4444; /* red-500 */
            cursor: pointer;
        }
        .grid-extra-number-button.selected {
            background-color: #facc15; /* yellow-400 */
            color: #111827; /* gray-900 */
            border-color: #eab308; /* yellow-600 */
            transform: scale(1.1);
        }
        .grid-extra-number-button:hover:not(.selected):not([disabled]) {
            background-color: #ef4444; /* red-500 */
        }
        .grid-extra-number-button[disabled] {
            cursor: not-allowed;
            opacity: 0.4;
        }
        /* Estilo para mostrar las bolas extra en los resultados */
        .extra-ball-display {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: #dc2626; /* red-600 */
            color: #fff;
            font-weight: bold;
            font-size: 1rem;
            margin-left: 8px;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        /* Estilo para los n√∫meros del simulador (Ganadores) */
        .sim-number-button {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.15s;
            background-color: #3b82f6; /* blue-500 */
            color: #fff;
            border: 1px solid #60a5fa; /* blue-400 */
            cursor: pointer;
        }
        .sim-number-button.selected {
            background-color: #10b981; /* emerald-500 */
            color: #111827; /* gray-900 */
            border-color: #059669;
            transform: scale(1.1);
        }
        .sim-number-button:hover:not(.selected):not([disabled]) {
            background-color: #60a5fa; /* blue-400 */
        }
        /* Protecci√≥n para banderas contra traducci√≥n autom√°tica */
.flag-protected {
    display: inline-block;
    font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
    -webkit-user-select: none;
    user-select: none;
}
    </style>
</head>
<body class="min-h-screen bg-gray-950 p-6 text-gray-200">

    <div class="max-w-5xl mx-auto">
        <div class="mb-8 text-center">
            <div class="text-4xl font-extrabold text-yellow-500">GLOBAL LOTTO PRO</div>
        </div>
        <div id="app-container">
            </div>
    </div>

    <script>
        // --- 1. DATOS GLOBALES ---
        const LOTTERIES = {
            "North America": {
                "United States": { flag: "üá∫üá∏", nativeName: "United States", lotteries: [
                    { name: "Powerball", type: "pick5", range: 69, extra: { name: "Powerball", range: 26, count: 1 } },
                    { name: "Mega Millions", type: "pick5", range: 70, extra: { name: "Mega Ball", range: 25, count: 1 } }
                ]},
                "Canada": { flag: "üá®üá¶", nativeName: "Canada", lotteries: [
                    { name: "Lotto 6/49", type: "pick6", range: 49 }
                ]}
            },
            "Europe": {
                "Transnational": { flag: "üá™üá∫", nativeName: "Europe", lotteries: [
                    { name: "EuroMillions", type: "pick5", range: 50, extra: { name: "Lucky Stars", range: 12, count: 2 } },
                    { name: "EuroJackpot", type: "pick5", range: 50, extra: { name: "Euro Numbers", range: 12, count: 2 } }
                ]},
                "Spain": { flag: "üá™üá∏", nativeName: "Espa√±a", lotteries: [
                    { name: "La Primitiva", type: "pick6", range: 49 }
                ]},
                "Italy": { flag: "üáÆüáπ", nativeName: "Italia", lotteries: [
                    { name: "SuperEnalotto", type: "pick6", range: 90 }
                ]},
                "United Kingdom": { flag: "üá¨üáß", nativeName: "United Kingdom", lotteries: [
                    { name: "UK National Lottery", type: "pick6", range: 59 }
                ]},
                "Germany": { flag: "üá©üá™", nativeName: "Deutschland", lotteries: [
                    { name: "Lotto 6 aus 49", type: "pick6", range: 49 }
                ]}
            },
            "South America": {
                "Brazil": { flag: "üáßüá∑", nativeName: "Brasil", lotteries: [
                    { name: "Mega-Sena", type: "pick6", range: 60 }
                ]},
                "Argentina": { flag: "üá¶üá∑", nativeName: "Argentina", lotteries: [
                    { name: "Loto", type: "pick6", range: 46 }
                ]},
                "Colombia": { flag: "üá®üá¥", nativeName: "Colombia", lotteries: [
                    { name: "Baloto", type: "pick5", range: 43, extra: { name: "Superbalota", range: 16, count: 1 } }
                ]}
            },
            "Asia": {
                "Philippines": { flag: "üáµüá≠", nativeName: "Philippines", lotteries: [
                    { name: "Grand Lotto 6/55", type: "pick6", range: 55 },
                    { name: "Ultra Lotto 6/58", type: "pick6", range: 58 }
                ]},
                "Hong Kong": { flag: "üá≠üá∞", nativeName: "È¶ôÊ∏Ø", lotteries: [
                    { name: "Mark Six", type: "pick6", range: 49 }
                ]},
                "Singapore": { flag: "üá∏üá¨", nativeName: "Singapore", lotteries: [
                    { name: "Toto", type: "pick6", range: 49 }
                ]}
            },
            "Oceania": {
                "Australia": { flag: "üá¶üá∫", nativeName: "Australia", lotteries: [
                    { name: "Oz Lotto", type: "pick6", range: 47 },
                    { name: "Powerball Australia", type: "pick6", range: 35, extra: { name: "Powerball", range: 20, count: 1 } }
                ]}
            },
            "Africa": {
                "South Africa": { flag: "üáøüá¶", nativeName: "South Africa", lotteries: [
                    { name: "South African Lotto", type: "pick6", range: 52 }
                ]}
            }
        };

        // --- F√≥rmulas Pick 5 y Pick 6 (Sin cambios) ---
        const FORMULAS_PICK5 = {
            8: [[1,2,4,7,8],[1,3,5,6,7],[2,3,4,6,8]],
            9: [[1,2,5,6,8],[1,2,3,4,7],[3,4,6,7,8],[1,3,6,7,9],[2,5,7,8,9],[1,3,4,5,9]],
            10: [[2,4,5,6,10],[1,5,6,7,9],[2,3,5,6,8],[1,3,5,9,10],[2,7,8,9,10],[4,5,7,8,10],[3,4,6,7,9],[1,3,6,8,10],[1,2,3,4,7],[1,2,4,8,9]],
            11: [[2,4,6,7,11],[2,3,5,6,10],[1,2,6,8,9],[1,3,4,10,11],[4,5,8,9,11],[3,7,8,9,10],[1,4,5,6,7],[3,6,7,9,11],[5,6,8,10,11],[2,3,4,7,8],[2,4,5,9,10],[1,2,7,10,11],[1,2,3,5,9],[1,3,4,6,8],[1,5,7,8,10]],
            12: [[1,2,4,6,9],[1,5,8,9,12],[1,3,9,10,11],[1,6,7,8,10],[1,4,7,11,12],[1,2,3,5,7],[3,6,7,9,12],[4,5,7,9,10],[2,7,8,9,11],[4,5,6,8,11],[2,5,6,10,12],[2,3,4,8,12],[3,4,6,10,11],[1,2,6,11,12],[1,2,4,8,10],[3,5,6,8,9],[8,9,10,11,12],[3,5,7,11,12],[2,4,5,9,11],[1,3,4,5,6]],
            13: [[1,2,3,4,5],[1,2,6,7,8],[1,2,9,10,11],[1,3,6,9,12],[1,3,7,10,13],[1,4,6,11,13],[1,4,8,10,12],[1,5,7,11,12],[1,5,8,9,13],[2,3,8,11,12],[2,4,7,9,12],[2,5,6,10,12],[2,3,6,9,13],[2,4,8,10,13],[2,5,7,11,13],[3,4,5,6,7],[3,4,8,9,11],[5,6,8,10,11],[6,7,8,12,13],[9,10,11,12,13],[3,4,5,12,13],[3,5,7,9,10],[4,6,7,9,10],[2,4,6,11,12],[2,5,8,9,12],[3,4,7,10,11],[1,3,6,8,10]],
            14: [[4,6,7,8,10],[1,3,7,10,12],[5,7,9,10,14],[5,6,7,11,12],[3,6,7,13,14],[4,7,9,12,13],[1,4,7,11,14],[3,7,8,9,11],[1,5,7,8,13],[1,6,9,10,11],[3,4,5,10,11],[8,10,11,12,14],[5,6,10,12,13],[1,4,10,13,14],[3,8,9,10,13],[3,4,6,8,12],[1,4,5,6,9],[1,8,9,12,14],[1,3,11,12,13],[5,9,11,13,14],[4,6,8,11,13],[3,5,6,8,14],[3,4,5,12,14],[4,9,10,11,12],[1,5,8,10,11],[3,4,6,9,14],[1,6,7,12,14],[2,7,10,11,13],[1,2,3,4,8],[2,5,8,9,12],[1,2,6,9,13],[2,3,5,6,7],[2,6,11,12,14],[2,4,7,8,14],[1,2,3,10,14]],
            15: [[1,2,3,4,5],[1,2,6,7,8],[1,2,9,10,11],[1,2,12,13,14],[1,3,6,9,12],[1,3,7,10,13],[1,3,8,11,14],[1,4,6,10,14],[1,4,7,9,15],[1,5,6,11,13],[1,5,8,10,12],[2,3,6,10,15],[2,3,7,9,14],[2,4,6,9,13],[2,4,7,10,12],[2,4,8,11,15],[2,5,7,13,15],[3,4,6,7,11],[3,4,8,9,10],[3,4,12,13,15],[3,5,9,11,15],[4,5,7,8,14],[4,9,11,12,14],[5,6,7,9,10],[5,6,12,14,15],[7,8,9,11,13],[7,10,11,14,15],[2,5,8,9,12],[2,8,10,13,14],[3,5,6,8,13],[3,7,8,12,15],[4,5,10,11,13],[6,8,9,14,15],[6,8,10,11,12],[9,10,12,13,15],[1,5,7,11,12],[1,5,9,13,14],[2,3,11,12,13],[2,5,6,11,14],[3,5,10,12,14],[6,7,12,13,14],[1,4,8,12,13]]
        };

        const FORMULAS_PICK6 = {
            9: [[1,2,3,5,6,8],[1,2,4,5,6,9],[1,2,5,6,7,9],[1,3,4,5,6,7],[1,3,5,6,8,9],[1,4,5,6,7,8],[2,3,4,7,8,9]],
            10: [[1,2,4,5,7,9],[2,4,6,7,8,10],[1,2,3,6,8,9],[3,5,7,8,9,10],[2,4,5,6,9,10],[1,3,4,8,9,10],[3,4,5,6,7,8],[1,2,3,5,6,10],[1,3,6,7,9,10],[1,2,5,7,8,10]],
            11: [[2,3,4,6,7,9],[3,4,5,7,8,10],[4,5,6,8,9,11],[1,5,6,7,9,10],[2,6,7,8,10,11],[1,3,7,8,9,11],[1,2,4,8,9,10],[2,3,5,9,10,11],[1,3,4,6,10,11],[1,2,4,5,7,11],[1,2,3,5,6,8],[1,2,3,4,5,9],[1,2,3,6,7,10],[1,2,5,8,10,11],[1,4,5,6,7,8]],
            12: [[2,3,4,6,7,9],[3,4,5,7,8,10],[4,5,6,8,9,11],[1,5,6,7,9,12],[2,6,7,8,10,12],[1,3,7,8,9,11],[1,2,4,8,9,12],[2,3,5,9,10,11],[1,3,4,6,10,12],[1,2,4,5,7,11],[1,2,3,5,6,8],[1,2,4,10,11,12],[1,5,8,10,11,12],[3,5,6,7,11,12],[4,7,9,10,11,12],[2,3,4,8,11,12],[1,2,6,9,10,11],[3,6,8,9,10,12],[1,2,3,7,10,12],[2,4,5,6,10,12]],
            13: [[2,4,7,8,9,10],[4,6,7,10,11,12],[1,6,7,9,11,13],[2,5,6,8,9,10],[1,6,7,8,10,11],[1,2,4,6,10,13],[1,8,10,11,12,13],[5,7,8,9,10,13],[1,3,4,6,12,13],[3,4,6,10,12,13],[3,6,7,8,10,13],[4,5,6,8,9,10],[3,6,7,8,9,10],[1,4,5,6,8,10],[2,3,6,8,10,12],[4,5,6,10,11,13],[2,4,6,8,10,11],[4,5,6,8,9,11],[3,9,10,11,12,13],[4,5,7,9,11,12],[1,6,8,9,11,12],[2,3,5,6,9,10],[1,4,7,8,11,12],[4,6,7,8,12,13],[1,2,8,11,12,13],[2,5,6,9,11,13],[1,5,7,8,10,12],[1,3,4,5,8,9],[3,6,7,8,11,12],[4,5,6,8,9,12],[1,2,5,8,9,10],[3,6,7,8,10,11]],
            14: [[2,5,7,8,10,14],[4,5,6,7,10,12],[1,6,7,9,11,14],[2,5,6,9,10,14],[1,6,7,10,12,14],[2,4,6,10,13,14],[1,5,8,10,11,13],[5,7,8,9,13,14],[1,3,6,7,12,13],[3,4,6,8,13,14],[3,6,7,8,13,14],[4,5,6,8,10,14],[3,6,7,8,13,14],[3,4,5,6,8,10],[3,6,7,8,10,12],[4,5,6,10,11,13],[2,5,6,8,11,14],[2,4,5,6,11,14],[3,9,10,11,12,13],[1,4,7,9,11,12],[1,6,8,9,11,14],[3,5,6,9,10,14],[1,5,8,11,12,14],[1,6,7,8,12,13],[1,2,7,11,12,13],[2,7,9,11,13,14],[1,5,7,8,10,12],[1,3,4,5,8,9],[3,6,7,8,11,12],[4,5,6,8,9,12],[1,8,9,10,12,14],[3,7,8,9,10,11],[1,2,3,4,7,10],[1,2,3,5,13,14],[2,3,4,9,12,14],[2,4,8,10,11,12],[1,2,3,6,10,11],[1,2,4,6,9,13]],
            15: [[2,5,7,8,10,14],[4,6,7,8,10,12],[1,6,7,9,11,14],[2,5,6,9,10,14],[1,3,6,7,10,15],[2,4,6,10,12,13],[1,7,8,10,13,15],[2,5,7,8,13,14],[1,6,8,12,13,15],[3,4,6,13,14,15],[3,5,6,7,8,14],[3,4,5,6,8,10],[2,3,6,7,8,14],[4,5,6,8,10,11],[3,6,8,10,12,15],[4,5,6,10,11,15],[2,6,7,8,11,15],[3,4,5,6,11,14],[3,9,10,11,13,15],[4,7,9,11,12,13],[1,6,8,9,11,14],[3,5,6,9,10,14],[1,8,11,12,14,15],[6,7,8,12,13,15],[1,6,11,12,13,15],[2,4,9,11,13,14],[1,5,7,8,10,13],[3,4,5,8,9,11],[3,6,7,8,11,12],[4,5,6,8,9,12],[1,8,9,10,12,14],[1,2,3,4,5,7],[1,2,3,6,9,12],[1,2,3,8,10,11],[1,2,4,8,9,15],[1,2,5,10,12,15],[1,3,5,12,13,14],[2,3,4,11,12,15],[2,7,9,12,14,15],[1,2,5,6,11,13],[1,3,4,9,10,13],[1,4,5,7,14,15]],
            16: [[2,7,8,10,14,16],[4,6,7,10,12,16],[1,6,7,9,11,14],[2,5,6,9,10,14],[1,6,7,10,15,16],[2,4,6,10,13,16],[1,8,10,13,15,16],[5,7,8,13,14,16],[1,6,12,13,15,16],[3,4,6,13,14,16],[3,6,7,8,14,16],[4,5,6,8,10,16],[3,6,7,8,14,16],[4,5,6,8,10,16],[3,6,8,10,12,15],[4,5,6,10,11,15],[2,6,8,11,15,16],[4,5,6,11,14,16],[3,9,10,11,13,16],[4,7,9,11,12,16],[1,6,8,9,11,14],[3,5,6,9,10,14],[1,8,11,12,14,15],[6,7,8,12,13,15],[1,11,12,13,15,16],[2,9,11,13,14,16],[1,5,7,8,10,16],[3,4,5,8,9,16],[3,6,7,8,11,12],[4,5,6,8,9,12],[1,8,9,10,14,16],[3,7,8,10,11,16],[1,2,3,4,5,6],[1,2,3,7,8,9],[1,2,3,10,11,12],[1,2,3,13,14,15],[1,2,4,7,11,13],[1,2,4,8,12,16],[1,2,4,9,10,15],[1,2,5,7,12,14],[1,3,4,7,10,14],[1,3,4,9,12,13],[1,3,5,7,11,15],[1,5,10,11,13,14],[2,3,4,7,12,15],[2,3,4,8,11,14],[2,3,5,7,10,13],[2,3,6,9,12,16]]
        };
        // --- FIN DE F√ìRMULAS ---


        // --- CORE LOGIC: Mapeo de n√∫meros base a combinaciones finales ---
        function mapBaseNumbersToCombinations(baseNumbers, formula) {
            const finalBets = [];
            const sortedBaseNumbers = [...baseNumbers].sort((a, b) => a - b); 

            formula.forEach(combination => {
                const bet = combination.map(index => {
                    return sortedBaseNumbers[index - 1]; 
                });
                finalBets.push(bet);
            });
            return finalBets;
        }
        
        // Funci√≥n para generar n√∫meros aleatorios √∫nicos
        function getRandomUniqueNumbers(count, maxRange) {
            const numbers = new Set();
            while (numbers.size < count) {
                const num = Math.floor(Math.random() * maxRange) + 1;
                numbers.add(num);
            }
            return Array.from(numbers).sort((a, b) => a - b);
        }

        // --- FUNCIONALIDAD DE EXPORTACI√ìN (Sin cambios) ---
        function exportToTxt() {
            const lotto = state.selectedLottery;
            const combinations = state.finalCombinations;
            const extraNumbers = state.extraNumbers;
            
            if (!combinations || combinations.length === 0) {
                alert("No combinations to export.");
                return;
            }
            
            const extraInfo = extraNumbers.length > 0 
                ? `Extra Balls (${lotto.extra.name}): ${extraNumbers.join(', ')}`
                : "No extra balls selected/required.";

            const header = `--- Global Lotto Strategy Combinations ---\n`;
            const info = `Lottery: ${lotto.name}\nBase Numbers (${state.baseNumberCount}): ${state.baseNumbers.join(', ')}\nTotal Bets: ${combinations.length}\n${extraInfo}\n\n`;
            
            const combinationsText = combinations.map((bet, index) => {
                // Formato: N1, N2, N3, N4, N5 | E1, E2
                const mainNumbers = bet.join(', ');
                const extraPart = extraNumbers.length > 0 ? ` | ${extraNumbers.join(', ')}` : '';
                return `${mainNumbers}${extraPart}`; 
            }).join('\n');

            const footer = `\n--- END OF FILE ---\n\nDISCLAIMER: This file is for entertainment and theoretical strategy only and does not guarantee winnings. Gamble responsibly.`;

            const fileContent = header + info + combinationsText + footer;
            
            // Generar nombre de archivo (ej: Powerball_10Bases_20251124.txt)
            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const filename = `${lotto.name.replace(/\s/g, '')}_${state.baseNumberCount}Bases_${date}.txt`;

            // Crear el blob y descargar el archivo
            const blob = new Blob([fileContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }


        // --- 2. GESTI√ìN DE ESTADO Y NAVEGACI√ìN ---
        let state = {
            screen: 'continent',
            // Datos para la generaci√≥n de apuestas
            selectedContinent: null,
            selectedCountry: null,
            selectedLottery: null,
            baseNumberCount: 0,
            baseNumbers: [], 
            finalCombinations: null,
            extraNumbers: [],
            // Datos para la simulaci√≥n
            simLottery: null,
            simBaseCount: 0,
            simBaseNumbers: [],
            simWinningNumbers: [],
            simWinningExtraNumbers: [],
            simResults: null,
        };

        const appContainer = document.getElementById('app-container');

        // HISTORIAL DE NAVEGACI√ìN PARA EL BOT√ìN BACK
const navigationHistory = [];

function updateState(newState) {
    // Guardar el estado anterior en el historial (solo si cambia de pantalla)
    if (newState.screen && newState.screen !== state.screen) {
        navigationHistory.push({
            screen: state.screen,
            data: { ...state }
        });
        
        // Agregar entrada al historial del navegador
        window.history.pushState(
            { screen: newState.screen }, 
            '', 
            `#${newState.screen}`
        );
    }
    
    state = { ...state, ...newState };
    renderApp();
}

// MANEJAR EL BOT√ìN BACK DEL M√ìVIL
window.addEventListener('popstate', function(event) {
    if (navigationHistory.length > 0) {
        // Recuperar el estado anterior
        const previousState = navigationHistory.pop();
        state = { ...previousState.data };
        renderApp();
    } else {
        // Si no hay historial, volver a la pantalla inicial
        state.screen = 'continent';
        renderApp();
    }
});

// PREVENIR QUE EL PRIMER LOAD AGREGUE AL HISTORIAL
window.addEventListener('load', function() {
    window.history.replaceState({ screen: 'continent' }, '', '#continent');
});

        function resetApp() {
            updateState({
                screen: 'continent',
                selectedContinent: null,
                selectedCountry: null,
                selectedLottery: null,
                baseNumberCount: 0,
                baseNumbers: [],
                finalCombinations: null,
                extraNumbers: [],
                simLottery: null,
                simBaseCount: 0,
                simBaseNumbers: [],
                simWinningNumbers: [],
                simWinningExtraNumbers: [],
                simResults: null,
            });
        }
        
        // --- FUNCIONES DE NAVEGACI√ìN PRINCIPAL ---

        function goToSimSelection() {
             updateState({ 
                screen: 'simLotterySelection', 
                simLottery: null, 
                simBaseCount: 0, 
                simBaseNumbers: [], 
                simWinningNumbers: [],
                simWinningExtraNumbers: []
            });
        }
        
        function backToContinentScreen() {
             updateState({ screen: 'continent' });
        }
        
        // --- MANEJADORES DE EVENTOS DE N√öMEROS BASE (Generaci√≥n) ---

        function addBaseNumber(num) {
            const count = state.baseNumberCount;

            // Comportamiento de toggle
            if (state.baseNumbers.includes(num)) {
                removeBaseNumber(num);
                return; 
            }
            
            // Validaci√≥n: L√≠mite alcanzado
            if (state.baseNumbers.length >= count) {
                alert(`Error: You have already selected the maximum of ${count} base numbers.`);
                return;
            }

            const newNumbers = [...state.baseNumbers, num];
            newNumbers.sort((a, b) => a - b); 

            state.baseNumbers = newNumbers; 
            renderNumberSelectionScreen(); 
        }

        function removeBaseNumber(num) {
            const newNumbers = state.baseNumbers.filter(n => n !== num);
            
            state.baseNumbers = newNumbers;
            renderNumberSelectionScreen(); 
        }

        // --- MANEJADORES DE EVENTOS DE N√öMEROS EXTRA (Generaci√≥n) ---
        function addExtraNumber(num) {
            const extra = state.selectedLottery.extra;

            // Comportamiento de toggle
            if (state.extraNumbers.includes(num)) {
                removeExtraNumber(num);
                return; 
            }
            
            // Validaci√≥n: L√≠mite alcanzado
            if (state.extraNumbers.length >= extra.count) {
                alert(`Error: You have already selected the maximum of ${extra.count} ${extra.name}.`);
                return;
            }

            const newNumbers = [...state.extraNumbers, num];
            newNumbers.sort((a, b) => a - b); 

            state.extraNumbers = newNumbers; 
            renderExtraNumbersSelectionScreen(); 
        }

        function removeExtraNumber(num) {
            const newNumbers = state.extraNumbers.filter(n => n !== num);
            
            state.extraNumbers = newNumbers;
            renderExtraNumbersSelectionScreen(); 
        }

        function autoSelectExtraNumbers() {
            const extra = state.selectedLottery.extra;
            const randomNumbers = getRandomUniqueNumbers(extra.count, extra.range);
            
            updateState({ extraNumbers: randomNumbers });
            // Redirigir a resultados despu√©s de la selecci√≥n autom√°tica
            calculateAndGoToResults();
        }
        
        function calculateAndGoToResults() {
            const count = state.baseNumberCount;
            
            const isPick5 = state.selectedLottery.type === 'pick5';
            const formula = isPick5 ? FORMULAS_PICK5[count] : FORMULAS_PICK6[count];

            const finalBets = mapBaseNumbersToCombinations(state.baseNumbers, formula);

            updateState({ finalCombinations: finalBets, screen: 'results' });
        }
        
        function generateMainBets() {
            const lotto = state.selectedLottery;
            const count = state.baseNumberCount;
            const selectedCount = state.baseNumbers.length;

            if (selectedCount !== count) {
                alert(`Error: You must select exactly ${count} numbers before proceeding.`);
                return;
            }
            
            if (lotto.extra) {
                // Si hay bolas extra, vamos a la pantalla de selecci√≥n de extras
                updateState({ screen: 'extraNumberSelection', extraNumbers: [] });
            } else {
                // Si no hay, generamos y vamos directamente a resultados
                calculateAndGoToResults();
            }
        }

        // --- MANEJADORES DE EVENTOS DE N√öMEROS (Simulador) ---
        
        function handleSimNumberSelection(number, type) {
            const lotto = state.simLottery;
            const baseCount = state.simBaseCount;
            const requiredMainCount = lotto.type === 'pick5' ? 5 : 6;
            
            // El count requerido es baseCount solo para los Base Numbers.
            // Para los Winning Numbers, el count es 5 o 6.
            const requiredCount = (type === 'base') ? baseCount : requiredMainCount; 
            
            const currentArray = (type === 'base') ? state.simBaseNumbers : state.simWinningNumbers;
            const stateKey = (type === 'base') ? 'simBaseNumbers' : 'simWinningNumbers';
            
            let newNumbers = [...currentArray];
            
            if (newNumbers.includes(number)) {
                // Quitar n√∫mero
                newNumbers = newNumbers.filter(n => n !== number);
            } else {
                // A√±adir n√∫mero
                if (newNumbers.length < requiredCount) {
                    newNumbers.push(number);
                } else {
                    alert(`Error: Already selected the required ${requiredCount} numbers for this field.`);
                }
            }
            
            newNumbers.sort((a, b) => a - b);
            
            // IMPORTANTE: Si los Base Numbers cambian, debemos resetear la selecci√≥n de Winning Numbers, 
            // ya que ahora la lista de ganadores permitidos ha cambiado.
            if (type === 'base') {
                // Filtramos los Winning Numbers que ya no est√°n en los nuevos Base Numbers
                const updatedWinningNumbers = state.simWinningNumbers.filter(num => newNumbers.includes(num));
                
                updateState({ 
                    simBaseNumbers: newNumbers, 
                    simWinningNumbers: updatedWinningNumbers // Aplicamos el filtro
                });
            } else {
                updateState({ [stateKey]: newNumbers });
            }
            // Note: renderApp is called by updateState, which will call renderSimNumberInputScreen
        }
        
        function handleSimExtraNumberSelection(number) {
            const extra = state.simLottery.extra;
            const requiredCount = extra.count;
            let newNumbers = [...state.simWinningExtraNumbers];
            
            if (newNumbers.includes(number)) {
                newNumbers = newNumbers.filter(n => n !== number);
            } else {
                if (newNumbers.length < requiredCount) {
                    newNumbers.push(number);
                } else {
                    alert(`Error: Already selected the required ${requiredCount} ${extra.name}.`);
                }
            }
            
            newNumbers.sort((a, b) => a - b);
            updateState({ simWinningExtraNumbers: newNumbers });
            // Note: renderApp is called by updateState, which will call renderSimNumberInputScreen
        }

        function goToSimResults() {
            const lotto = state.simLottery;
            const baseCount = state.simBaseCount;
            const numType = lotto.type;
            
            const requiredMainCount = numType === 'pick5' ? 5 : 6;
            const requiredExtraCount = lotto.extra ? lotto.extra.count : 0;
            
            // 1. Validaciones
            if (state.simBaseNumbers.length !== baseCount) {
                alert(`Error: Must select exactly ${baseCount} Base Numbers.`);
                return;
            }
            if (state.simWinningNumbers.length !== requiredMainCount) {
                alert(`Error: Must select exactly ${requiredMainCount} Winning Numbers.`);
                return;
            }
            if (requiredExtraCount > 0 && state.simWinningExtraNumbers.length !== requiredExtraCount) {
                alert(`Error: Must select exactly ${requiredExtraCount} Winning ${lotto.extra.name}.`);
                return;
            }
            
            // 2. Generar apuestas con la f√≥rmula
            const formula = numType === 'pick5' ? FORMULAS_PICK5[baseCount] : FORMULAS_PICK6[baseCount];
            const allGeneratedBets = mapBaseNumbersToCombinations(state.simBaseNumbers, formula);
            
            // 3. Comparar y contar aciertos
            const results = {
                totalBets: allGeneratedBets.length,
                mainHits: {}, 
                extraHits: {}, 
                totalMatches: {}, 
            };

            const winningMainSet = new Set(state.simWinningNumbers);
            const winningExtraSet = new Set(state.simWinningExtraNumbers);
            
            allGeneratedBets.forEach(bet => {
                const mainMatches = bet.filter(num => winningMainSet.has(num)).length;
                
                let extraMatches = 0;
                if (requiredExtraCount > 0) {
                    // Contar cu√°ntos n√∫meros extra seleccionados est√°n en los n√∫meros extra ganadores
                    extraMatches = state.simWinningExtraNumbers.filter(num => winningExtraSet.has(num)).length;
                }
                
                // Contar aciertos principales
                results.mainHits[mainMatches] = (results.mainHits[mainMatches] || 0) + 1;
                
                // Contar aciertos totales (principal + extra)
                const matchKey = `${mainMatches}+${extraMatches}`;
                results.totalMatches[matchKey] = (results.totalMatches[matchKey] || 0) + 1;
            });
            
            // 4. Ir a la pantalla de resultados del simulador
            updateState({ simResults: results, screen: 'simResults' });
        }


        // --- 3. FUNCIONES DE RENDERIZADO POR PANTALLA ---

        function renderContinentScreen() {
            const html = `
                <div class="screen active" id="continent-screen">
                    <div class="text-center mb-12 pt-6">
                        <h1 class="text-4xl font-extrabold text-yellow-300 mb-6 tracking-tight">GLOBAL LOTTO STRATEGY</h1>
                        <p class="text-gray-400 text-lg">Select Your Continent or Run Simulator</p>
                    </div>
                    
                    <div class="mb-8 text-center">
                        <button 
                            onclick="goToSimSelection()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-extrabold text-2xl py-4 px-12 rounded-full transition-colors duration-200 shadow-xl shadow-blue-600/50 icon-sim transform hover:scale-105"
                        >
                            Simulador de Rendimiento
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${Object.keys(LOTTERIES).map(continent => `
                            <button
                                onclick="updateState({ screen: 'country', selectedContinent: '${continent}' })"
                                class="bg-gray-800/70 backdrop-blur-sm border border-gray-700 hover:border-yellow-500 hover:bg-gray-700/80 transition-all duration-300 p-7 rounded-2xl shadow-lg hover:shadow-yellow-500/30 text-white text-2xl font-semibold flex items-center justify-between group transform hover:-translate-y-1"
                            >
                                <span>${continent}</span>
                                <span class="icon-right text-yellow-400 group-hover:translate-x-2 transition-transform duration-300"></span>
                            </button>
                        `).join('')}
                    </div>

                    <div class="mt-12 p-4 rounded-xl bg-red-900/50 border border-red-700 shadow-xl text-center">
                        <p class="text-red-400 text-lg font-bold mb-1">‚ö†Ô∏è IMPORTANT DISCLAIMER & RESPONSIBLE GAMING</p>
                        <p class="text-red-300 text-sm">
                            This application is for **entertainment and theoretical strategy only**. It is not affiliated with any official lottery organization and **does not guarantee winnings**.
                            <br>
                            **Gamble responsibly.** Never bet more than you can afford to lose. Must be 18+ to play. If you feel gambling is becoming a problem, seek professional help.
                        </p>
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }

        // --- SIMULATOR SCREENS ---

        function renderSimLotterySelectionScreen() {
            // Recopila todas las loter√≠as disponibles para simplificar la selecci√≥n en el simulador
            const allLotteries = Object.values(LOTTERIES).flatMap(countries => 
                Object.values(countries).flatMap(country => 
                    country.lotteries.map(lotto => ({
                        ...lotto,
                        country: country.nativeName,
                        flag: country.flag
                    }))
                )
            ).sort((a, b) => a.name.localeCompare(b.name));

            const handleSelectLotto = (lottery) => {
                updateState({ simLottery: lottery, screen: 'simBaseCountSelection' });
            };

            const html = `
                <div class="screen active" id="sim-lottery-selection-screen">
                    <button onclick="backToContinentScreen()" class="text-yellow-400 hover:text-yellow-300 mb-6 font-semibold flex items-center gap-2">
                        <span class="icon-left w-5 h-5 transform rotate-180"></span> Back to Main Menu
                    </button>
                    
                    <div class="text-center mb-10">
                        <h2 class="text-4xl font-bold text-blue-400 mb-2 icon-sim">Simulador: Select Lottery</h2>
                        <p class="text-gray-400 text-lg">Choose a lottery to test the Pyramidal Algorithm.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[600px] overflow-y-auto p-2">
                        ${allLotteries.map(lottery => {
                            const lotteryString = JSON.stringify(lottery).replace(/"/g, '&quot;');
                            return `
                                <button
                                    onclick="updateState({ simLottery: ${lotteryString}, screen: 'simBaseCountSelection' })"
                                    class="bg-gray-800/70 backdrop-blur-sm hover:bg-gray-700/80 transition-all duration-300 p-4 rounded-xl border-2 border-blue-500/30 hover:border-blue-500 shadow-xl group transform hover:scale-[1.01]"
                                >
                                    <div class="flex items-center justify-between">
                                        <div class="text-left">
                                            <h3 class="text-2xl font-bold mb-1 text-white flex items-center gap-2">
                                               <span class="flag-icon text-base flag-protected" translate="no">${lottery.flag}</span>
                                                ${lottery.name}
                                            </h3>
                                            <p class="text-gray-400 text-sm">
                                                ${lottery.type === 'pick5' ? 'Pick 5' : 'Pick 6'} ‚Ä¢ Range: 1-${lottery.range}
                                                ${lottery.extra ? ` + ${lottery.extra.name}` : ''}
                                            </p>
                                        </div>
                                        <span class="icon-right w-6 h-6 text-blue-400 group-hover:translate-x-2 transition-transform duration-300"></span>
                                    </div>
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }

        function renderSimBaseCountSelectionScreen() {
            const lotto = state.simLottery;
            const formulas = lotto.type === 'pick5' ? FORMULAS_PICK5 : FORMULAS_PICK6;
            const minNumbers = lotto.type === 'pick5' ? 8 : 9;
            const maxNumbers = lotto.type === 'pick5' ? 15 : 16;
            
            const handleSelectCount = (count) => {
                updateState({ 
                    screen: 'simNumberInput', 
                    simBaseCount: count,
                    simBaseNumbers: [], 
                    simWinningNumbers: [],
                    simWinningExtraNumbers: []
                });
            };

            const numButtons = Array.from({ length: maxNumbers - minNumbers + 1 }, (_, i) => minNumbers + i).map((numCount) => {
                const bets = formulas[numCount]?.length || 0;
                return `
                    <button
                        onclick="(${handleSelectCount})(${numCount})"
                        class="bg-gray-800/70 backdrop-blur-sm hover:bg-gray-700/80 transition-all duration-300 p-4 rounded-xl border-2 border-blue-500/30 hover:border-blue-500 shadow-lg group transform hover:scale-[1.05]"
                    >
                        <div class="text-center">
                            <div class="text-4xl font-extrabold mb-2 text-blue-400">${numCount}</div>
                            <div class="text-sm text-gray-400 uppercase tracking-wider">Base Numbers</div>
                            <div class="mt-3 pt-3 border-t border-blue-500/30">
                                <div class="text-xl font-semibold text-white">${bets}</div>
                                <div class="text-xs text-gray-400">Total Bets</div>
                            </div>
                        </div>
                    </button>
                `;
            }).join('');

            const html = `
                <div class="screen active" id="sim-base-count-selection-screen">
                    <button onclick="updateState({ screen: 'simLotterySelection', simBaseCount: 0 })" class="text-yellow-400 hover:text-yellow-300 mb-6 font-semibold flex items-center gap-2">
                        <span class="icon-left w-5 h-5 transform rotate-180"></span> Back to Lottery Selection
                    </button>
                    
                    <div class="text-center mb-10">
                        <h2 class="text-4xl font-bold text-blue-400 mb-2 icon-sim">${lotto.name} Simulator</h2>
                        <p class="text-gray-400 text-lg">Select the amount of **Base Numbers** you want to simulate playing with.</p>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        ${numButtons}
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }

        function renderSimNumberInputScreen() {
            const lotto = state.simLottery;
            const baseCount = state.simBaseCount;
            const requiredMainCount = lotto.type === 'pick5' ? 5 : 6;
            const requiredExtraCount = lotto.extra ? lotto.extra.count : 0;
            const mainRange = lotto.range;
            const extraRange = lotto.extra ? lotto.extra.range : 0;
            
            // N√∫meros disponibles para las cuadr√≠culas
            const availableBaseNumbers = Array.from({ length: mainRange }, (_, i) => i + 1); // Rango completo
            const availableWinningNumbers = state.simBaseNumbers; // <--- CLAVE: Solo los n√∫meros base seleccionados

            const selectedBaseCount = state.simBaseNumbers.length;
            const selectedWinningCount = state.simWinningNumbers.length;
            const selectedExtraCount = state.simWinningExtraNumbers.length;
            
            // --- Creador de Cuadr√≠cula (Reutilizado) ---
            const createNumberGrid = (availableNumbers, currentNumbers, requiredCount, handler, customClass = '') => {
                // Determina la cantidad de columnas bas√°ndose en el rango m√°s grande posible (10 es un buen max)
                const rangeMax = availableNumbers.length > 0 ? Math.max(...availableNumbers) : 1;
                const gridColumns = Math.min(10, Math.ceil(rangeMax / 10) > 0 ? Math.ceil(rangeMax / 10) : 10);
                
                // Si la lista de n√∫meros disponibles est√° vac√≠a, mostrar un mensaje
                if (availableNumbers.length === 0 && handler.params === 'winning') {
                    return `
                        <p class="text-center text-red-400 font-semibold p-4">
                            First, select your Base Numbers in the section above.
                        </p>
                    `;
                }

                if (availableNumbers.length === 0 && handler.params === 'base') {
                     // Esto no deber√≠a suceder si el rango es > 0, pero por si acaso.
                    return `<p class="text-center text-red-400 font-semibold p-4">No available numbers in this range (1 to ${mainRange}).</p>`;
                }
                
                return `
                    <div class="flex justify-center p-4">
                        <div style="display: grid; grid-template-columns: repeat(${gridColumns}, 1fr); gap: 8px;">
                            ${availableNumbers.map(num => {
                                // Determinar la funci√≥n de llamada
                                let handlerCall;
                                if (handler.name === 'handleSimExtraNumberSelection') {
                                    handlerCall = `handleSimExtraNumberSelection(${num})`;
                                } else {
                                    // Para handleSimNumberSelection, el segundo par√°metro es el tipo ('base' o 'winning')
                                    handlerCall = `handleSimNumberSelection(${num}, '${handler.params}')`;
                                }
                                
                                return `
                                    <button 
                                        onclick="${handlerCall}" 
                                        class="${customClass} ${currentNumbers.includes(num) ? 'selected' : ''}"
                                        ${currentNumbers.length >= requiredCount && !currentNumbers.includes(num) ? 'disabled' : ''}
                                    >
                                        ${num}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            };

            // Grid 1: N√∫meros Base (Rango completo)
            const baseGrid = createNumberGrid(availableBaseNumbers, state.simBaseNumbers, baseCount, {name: 'handleSimNumberSelection', params: 'base'}, "grid-number-button");
            
            // Grid 2: N√∫meros Ganadores (Solo los n√∫meros base seleccionados)
            const winningGrid = createNumberGrid(availableWinningNumbers, state.simWinningNumbers, requiredMainCount, {name: 'handleSimNumberSelection', params: 'winning'}, "sim-number-button");
            
            let extraGrid = '';
            if (requiredExtraCount > 0) {
                // Grid 3: Bolas Extra (Rango completo de Bolas Extra)
                const availableExtraNumbers = Array.from({ length: extraRange }, (_, i) => i + 1); 
                extraGrid = createNumberGrid(availableExtraNumbers, state.simWinningExtraNumbers, requiredExtraCount, {name: 'handleSimExtraNumberSelection'}, "grid-extra-number-button");
            }
            
            // Mensaje de estado de Winning Numbers
            let winningMessage = `<p class="text-gray-400 mb-4">Select the **${requiredMainCount} Winning Numbers** **from your Base Numbers**.</p>`;
            if (availableWinningNumbers.length === 0) {
                 winningMessage = `<p class="text-lg font-semibold text-red-400 mb-4">You must first select your ${baseCount} Base Numbers in the section above.</p>`;
            }


            const html = `
                <div class="screen active" id="sim-number-input-screen">
                    <button onclick="updateState({ screen: 'simBaseCountSelection', simBaseNumbers: [] })" class="text-yellow-400 hover:text-yellow-300 mb-6 font-semibold flex items-center gap-2">
                        <span class="icon-left w-5 h-5 transform rotate-180"></span> Back to Base Count
                    </button>
                    
                    <div class="text-center mb-8">
                        <h2 class="text-4xl font-bold text-blue-400 mb-2 icon-sim">${lotto.name} Simulation</h2>
                        <p class="text-gray-400 text-lg">Define the numbers for your test.</p>
                    </div>

                    <div class="space-y-8">
                        <div class="bg-gray-800/70 p-6 rounded-2xl border border-yellow-500/30 shadow-xl">
                            <h3 class="text-2xl font-bold text-yellow-400 mb-4">Your Base Numbers (${selectedBaseCount}/${baseCount})</h3>
                            <p class="text-gray-400 mb-4">Select the **${baseCount} Base Numbers** you would have played with (from 1 to ${mainRange}).</p>
                            ${baseGrid}
                        </div>
                        
                        <div class="bg-gray-800/70 p-6 rounded-2xl border border-green-500/30 shadow-xl">
                            <h3 class="text-2xl font-bold text-green-400 mb-4">Actual Winning Numbers (${selectedWinningCount}/${requiredMainCount})</h3>
                            ${winningMessage}
                            ${winningGrid}
                        </div>

                        ${requiredExtraCount > 0 ? `
                            <div class="bg-gray-800/70 p-6 rounded-2xl border border-red-500/30 shadow-xl">
                                <h3 class="text-2xl font-bold text-red-400 mb-4">Winning ${lotto.extra.name} (${selectedExtraCount}/${requiredExtraCount})</h3>
                                <p class="text-gray-400 mb-4">Select the **${requiredExtraCount} Winning ${lotto.extra.name}** (from 1 to ${extraRange}).</p>
                                ${extraGrid}
                            </div>
                        ` : ''}
                    </div>

                    <div class="text-center mt-8">
                        <button 
                            onclick="goToSimResults()"
                            class="bg-green-600 hover:bg-green-700 text-white font-extrabold text-2xl py-4 px-12 rounded-full transition-colors duration-200 shadow-lg shadow-green-600/50 disabled:bg-gray-600 disabled:shadow-none icon-calc"
                            ${selectedBaseCount !== baseCount || selectedWinningCount !== requiredMainCount || (requiredExtraCount > 0 && selectedExtraCount !== requiredExtraCount) ? 'disabled' : ''}
                        >
                            Run Simulation
                        </button>
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }

        function renderSimResultsScreen() {
            const lotto = state.simLottery;
            const results = state.simResults;
            const requiredMainCount = lotto.type === 'pick5' ? 5 : 6;
            const requiredExtraCount = lotto.extra ? lotto.extra.count : 0;
            
            // Funci√≥n auxiliar para ordenar los resultados y dar formato
            const formatResults = (hits) => {
                return Object.keys(hits)
                    .sort((a, b) => parseInt(b) - parseInt(a)) // Ordenar de mayor a menor acierto
                    .filter(key => hits[key] > 0)
                    .map(key => `
                        <div class="flex justify-between items-center py-2 border-b border-gray-700 last:border-b-0">
                            <span class="text-xl font-bold ${key >= requiredMainCount-1 ? 'text-green-400' : 'text-yellow-400'}">${key} Correct</span>
                            <span class="text-2xl font-extrabold text-white">${hits[key]} Bets</span>
                        </div>
                    `).join('');
            };

            // Funci√≥n para formatear los resultados totales (principal + extra)
            const formatTotalMatches = (matches) => {
                return Object.keys(matches)
                    .sort((a, b) => {
                        const [mainA, extraA] = a.split('+').map(Number);
                        const [mainB, extraB] = b.split('+').map(Number);
                        // Ordenar primero por aciertos principales (desc) y luego por aciertos extra (desc)
                        if (mainA !== mainB) return mainB - mainA;
                        return extraB - extraA;
                    })
                    .filter(key => matches[key] > 0)
                    .map(key => {
                        const [main, extra] = key.split('+').map(Number);
                        const isTopPrize = main === requiredMainCount && extra === requiredExtraCount;
                        const isSignificant = main >= requiredMainCount - 1; // 5/6 o 4/5
                        
                        return `
                            <div class="flex justify-between items-center py-3 border-b border-gray-700 last:border-b-0 ${isTopPrize ? 'bg-yellow-900/40 rounded-lg px-2 my-1' : ''}">
                                <span class="text-xl font-bold ${isTopPrize ? 'text-red-400' : (isSignificant ? 'text-green-400' : 'text-gray-300')}">
                                    ${main} main ${requiredExtraCount > 0 ? `+ ${extra} ${lotto.extra.name}` : ''}
                                </span>
                                <span class="text-2xl font-extrabold ${isTopPrize ? 'text-red-300' : 'text-white'}">${matches[key]} Bets</span>
                            </div>
                        `;
                    }).join('');
            };


            const html = `
                <div class="screen active" id="sim-results-screen">
                    <button onclick="updateState({ screen: 'simNumberInput', simResults: null })" class="text-yellow-400 hover:text-yellow-300 mb-6 font-semibold flex items-center gap-2">
                        <span class="icon-left w-5 h-5 transform rotate-180"></span> Change Input Numbers
                    </button>

                    <div class="text-center mb-8">
                        <h2 class="text-4xl font-bold text-green-400 mb-2 icon-money">Simulation Results for ${lotto.name}</h2>
                        <p class="text-gray-400 text-lg">Performance of ${results.totalBets} bets generated from your ${state.simBaseCount} Base Numbers.</p>
                        
                        <div class="mt-4 p-3 bg-gray-800 rounded-xl inline-block text-left border border-gray-700">
                             <p class="text-sm text-yellow-300 font-semibold">Your Base Numbers: ${state.simBaseNumbers.join(', ')}</p>
                             <p class="text-sm text-green-300 font-semibold">Winning Numbers: ${state.simWinningNumbers.join(', ')}</p>
                             ${requiredExtraCount > 0 ? `<p class="text-sm text-red-300 font-semibold">Winning ${lotto.extra.name}: ${state.simWinningExtraNumbers.join(', ')}</p>` : ''}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        
                        <div class="bg-gray-800/70 p-6 rounded-2xl border border-yellow-500/30 shadow-2xl">
                            <h3 class="text-2xl font-bold text-yellow-400 mb-4 border-b pb-2 border-yellow-500/50">Main Number Hits (1-${requiredMainCount})</h3>
                            ${formatResults(results.mainHits)}
                        </div>
                        
                        <div class="bg-gray-800/70 p-6 rounded-2xl border border-red-500/30 shadow-2xl">
                            <h3 class="text-2xl font-bold text-red-400 mb-4 border-b pb-2 border-red-500/50">Total Match Performance</h3>
                            ${formatTotalMatches(results.totalMatches)}
                        </div>
                    </div>
                    
                    <div class="mt-10 p-4 rounded-xl bg-blue-900/50 border border-blue-700 shadow-xl text-center">
                        <p class="text-blue-300 text-lg font-bold">Simulaci√≥n de Inversi√≥n vs. Cobertura</p>
                        <p class="text-blue-200 text-sm">
                            The algorithm reduced a potential full wheel of hundreds/thousands of combinations to just **${results.totalBets} bets**, achieving the high level of hits shown above.
                        </p>
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }


        // --- OTRAS PANTALLAS (No se muestran completas por brevedad, pero est√°n en el script) ---
        function renderCountryScreen() {
            const countriesData = LOTTERIES[state.selectedContinent];
            const html = `
                <div class="screen active" id="country-screen">
                    <button onclick="resetApp()" class="text-yellow-400 hover:text-yellow-300 mb-6 font-semibold flex items-center gap-2">
                        <span class="icon-left w-5 h-5 transform rotate-180"></span> Back to Continents
                    </button>
                    
                    <div class="text-center mb-10">
                        <div class="flex items-center justify-center gap-4 mb-2">
                            <span class="flag-icon flag-protected" translate="no">${countriesData[Object.keys(countriesData)[0]].flag}</span>
                            <h2 class="text-4xl font-bold text-white mb-2 tracking-wide">${state.selectedContinent}</h2>
                        </div>
                        <p class="text-gray-400 text-lg">Select the Country</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${Object.keys(countriesData).map(countryKey => {
                            const country = countriesData[countryKey];
                            return `
                                <button
                                    onclick="updateState({ screen: 'lottery', selectedCountry: '${countryKey}' })"
                                    class="bg-gray-800/70 backdrop-blur-sm border border-gray-700 hover:border-yellow-500 hover:bg-gray-700/80 transition-all duration-300 p-7 rounded-2xl shadow-lg hover:shadow-yellow-500/30 text-white text-2xl font-semibold flex items-center justify-between group transform hover:-translate-y-1"
                                >
                                    <div class="flex items-center gap-4">
                                        <span class="flag-icon flag-protected" translate="no">${country.flag}</span>
                                        <div>
                                            <span>${countryKey}</span>
                                            <span class="text-sm text-gray-400 block font-normal">${country.nativeName}</span>
                                        </div>
                                    </div>
                                    <span class="icon-right text-yellow-400 group-hover:translate-x-2 transition-transform duration-300"></span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }

        function renderLotteryScreen() {
            const countryData = LOTTERIES[state.selectedContinent][state.selectedCountry];
            const lotteries = countryData.lotteries;
            const html = `
                <div class="screen active" id="lottery-screen">
                    <button onclick="updateState({ screen: 'country', selectedLottery: null })" class="text-yellow-400 hover:text-yellow-300 mb-6 font-semibold flex items-center gap-2">
                        <span class="icon-left w-5 h-5 transform rotate-180"></span> Back to Countries
                    </button>
                    
                    <div class="text-center mb-10">
                        <div class="flex items-center justify-center gap-4 mb-2">
                            <span class="flag-icon flag-protected" translate="no">${countryData.flag}</span>
                            <h2 class="text-4xl font-bold text-yellow-400 tracking-wide">${state.selectedCountry}</h2>
                        </div>
                        <p class="text-gray-400 text-lg">Select the Lottery</p>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        ${lotteries.map((lottery, index) => {
                            const lotteryString = JSON.stringify(lottery).replace(/"/g, '&quot;');
                            return `
                                <button
                                    onclick="updateState({ screen: 'combinations', selectedLottery: ${lotteryString} })"
                                    class="bg-gray-800/70 backdrop-blur-sm hover:bg-gray-700/80 transition-all duration-300 p-6 rounded-2xl border-2 border-yellow-500/30 hover:border-yellow-500 shadow-xl group transform hover:scale-[1.01]"
                                >
                                    <div class="flex items-center justify-between">
                                        <div class="text-left">
                                            <h3 class="text-3xl font-bold mb-1 text-white">${lottery.name}</h3>
                                            <p class="text-gray-400 text-base">
                                                ${lottery.type === 'pick5' ? 'Pick 5' : 'Pick 6'} ‚Ä¢ Range: 1-${lottery.range}
                                                ${lottery.extra ? ` + ${lottery.extra.name} (${lottery.extra.count} of 1-${lottery.extra.range})` : ''}
                                            </p>
                                        </div>
                                        <span class="icon-right w-7 h-7 text-yellow-400 group-hover:translate-x-2 transition-transform duration-300"></span>
                                    </div>
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }

        function renderCombinationsScreen() {
            const handleSelectCount = (count) => {
                updateState({ 
                    screen: 'numberSelection', 
                    baseNumberCount: count,
                    baseNumbers: [], 
                    extraNumbers: [],
                    finalCombinations: null
                });
            };

            const formulas = state.selectedLottery.type === 'pick5' ? FORMULAS_PICK5 : FORMULAS_PICK6;
            const minNumbers = state.selectedLottery.type === 'pick5' ? 8 : 9;
            const maxNumbers = state.selectedLottery.type === 'pick5' ? 15 : 16;
            
            const numButtons = Array.from({ length: maxNumbers - minNumbers + 1 }, (_, i) => minNumbers + i).map((numCount) => {
                const bets = formulas[numCount]?.length || 0;
                return `
                    <button
                        onclick="(${handleSelectCount})(${numCount})"
                        class="bg-gray-800/70 backdrop-blur-sm hover:bg-gray-700/80 transition-all duration-300 p-4 rounded-xl border-2 border-yellow-500/30 hover:border-yellow-500 shadow-lg group transform hover:scale-[1.05]"
                    >
                        <div class="text-center">
                            <div class="text-4xl font-extrabold mb-2 text-yellow-400">${numCount}</div>
                            <div class="text-sm text-gray-400 uppercase tracking-wider">Base Numbers</div>
                            <div class="mt-3 pt-3 border-t border-yellow-500/30">
                                <div class="text-xl font-semibold text-white">${bets}</div>
                                <div class="text-xs text-gray-400">Bets (Combinations)</div>
                            </div>
                        </div>
                    </button>
                `;
            }).join('');

            const html = `
                <div class="screen active" id="combinations-screen">
                    <button onclick="updateState({ screen: 'lottery' })" class="text-yellow-400 hover:text-yellow-300 mb-6 font-semibold flex items-center gap-2">
                        <span class="icon-left w-5 h-5 transform rotate-180"></span> Back to Lotteries
                    </button>
                    
                    <div class="text-center mb-10">
                        <span class="icon-dice text-yellow-400 w-12 h-12 mx-auto mb-4 inline-block text-3xl"></span>
                        <h2 class="text-4xl font-bold text-yellow-400 mb-2">${state.selectedLottery.name}</h2>
                        <p class="text-gray-400 text-lg">Select how many **Base Numbers** you want to play</p>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        ${numButtons}
                    </div>

                    <div class="mt-10 bg-gray-800/70 rounded-2xl p-6 border-2 border-yellow-500 shadow-2xl">
                        <div class="flex items-start gap-4">
                            <span class="icon-calc text-yellow-400 w-8 h-8 flex-shrink-0 mt-1 text-2xl"></span>
                            <div class="text-gray-200">
                                <p class="font-extrabold mb-2 text-2xl text-yellow-300">Pyramidal Algorithm Pro‚Ñ¢</p>
                                <p class="text-base text-gray-300">
                                    This system reduces the complexity of thousands of possible combinations to an optimal set of bets.
                                    Select your most probable **Base Numbers** and the algorithm maximizes your hit coverage with reduced investment.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }

        function renderNumberSelectionScreen() {
            const lotto = state.selectedLottery;
            const count = state.baseNumberCount;
            const selectedNumbers = state.baseNumbers;
            const range = lotto.range;
            const remaining = count - selectedNumbers.length;

            const gridColumns = Math.min(10, Math.ceil(range / 10)); 

            const numberGrid = Array.from({ length: range }, (_, i) => i + 1).map(num => `
                <button 
                    onclick="addBaseNumber(${num})" 
                    class="grid-number-button ${selectedNumbers.includes(num) ? 'selected' : ''}"
                    ${selectedNumbers.length >= count && !selectedNumbers.includes(num) ? 'disabled' : ''}
                >
                    ${num}
                </button>
            `).join('');

            const html = `
                <div class="screen active" id="number-selection-screen">
                    <button onclick="updateState({ screen: 'combinations', baseNumberCount: 0, baseNumbers: [] })" class="text-yellow-400 hover:text-yellow-300 mb-6 font-semibold flex items-center gap-2">
                        <span class="icon-left w-5 h-5 transform rotate-180"></span> Back to Base Number Count
                    </button>
                    
                    <div class="text-center mb-8">
                        <h2 class="text-4xl font-bold text-yellow-400 mb-2">${lotto.name}</h2>
                        <p class="text-gray-400 text-lg">Select **${count} Base Numbers** (Range: 1 to ${range})</p>
                    </div>

                    <div class="bg-gray-800/70 p-6 rounded-2xl border border-yellow-500/30 mb-8 shadow-xl">
                        <div class="text-center mb-4">
                            ${remaining > 0 
                                ? `<p class="text-2xl font-bold text-red-400">Remaining to select: ${remaining} numbers</p>`
                                : `<p class="text-2xl font-bold text-green-400 icon-check">All ${count} numbers selected!</p>`
                            }
                        </div>
                        
                        <div class="flex justify-center p-4">
                            <div style="display: grid; grid-template-columns: repeat(${gridColumns}, 1fr); gap: 8px;">
                                ${numberGrid}
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button 
                            onclick="generateMainBets()"
                            class="bg-green-600 hover:bg-green-700 text-white font-extrabold text-2xl py-4 px-12 rounded-full transition-colors duration-200 shadow-lg shadow-green-600/50 disabled:bg-gray-600 disabled:shadow-none"
                            ${remaining > 0 ? 'disabled' : ''}
                        >
                            ${lotto.extra ? `Next: Select ${lotto.extra.name}` : `Generate ${lotto.type === 'pick5' ? FORMULAS_PICK5[count].length : FORMULAS_PICK6[count].length} Bets`}
                        </button>
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }

        function renderExtraNumbersSelectionScreen() {
            const lotto = state.selectedLottery;
            const extra = lotto.extra;
            const selectedNumbers = state.extraNumbers;
            const remaining = extra.count - selectedNumbers.length;

            const gridColumns = Math.min(10, Math.ceil(extra.range / 10)); 

            const numberGrid = Array.from({ length: extra.range }, (_, i) => i + 1).map(num => `
                <button 
                    onclick="addExtraNumber(${num})" 
                    class="grid-extra-number-button ${selectedNumbers.includes(num) ? 'selected' : ''}"
                    ${selectedNumbers.length >= extra.count && !selectedNumbers.includes(num) ? 'disabled' : ''}
                >
                    ${num}
                </button>
            `).join('');
            
            const html = `
                <div class="screen active" id="extra-selection-screen">
                    <button onclick="updateState({ screen: 'numberSelection', extraNumbers: [] })" class="text-yellow-400 hover:text-yellow-300 mb-6 font-semibold flex items-center gap-2">
                        <span class="icon-left w-5 h-5 transform rotate-180"></span> Back to Main Numbers
                    </button>
                    
                    <div class="text-center mb-8">
                        <h2 class="text-4xl font-bold text-red-400 mb-2 icon-star">Select Your ${extra.name}</h2>
                        <p class="text-gray-400 text-lg">Choose **${extra.count} numbers** (Range: 1 to ${extra.range}) for the ${extra.name}.</p>
                    </div>
                    
                    <div class="bg-gray-800/70 p-6 rounded-2xl border border-red-500/30 mb-8 shadow-xl">
                        <div class="text-center mb-4">
                            ${remaining > 0 
                                ? `<p class="text-2xl font-bold text-red-400">Remaining to select: ${remaining} ${extra.name}</p>`
                                : `<p class="text-2xl font-bold text-green-400 icon-check">All ${extra.count} ${extra.name} selected!</p>`
                            }
                        </div>
                        
                        <div class="flex justify-center p-4">
                            <div style="display: grid; grid-template-columns: repeat(${gridColumns}, 1fr); gap: 8px;">
                                ${numberGrid}
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-center gap-4">
                        <button 
                            onclick="autoSelectExtraNumbers()"
                            class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold text-xl py-3 px-8 rounded-full transition-colors duration-200 icon-magic shadow-lg shadow-yellow-600/50"
                        >
                            Select Randomly
                        </button>
                        
                        <button 
                            onclick="calculateAndGoToResults()"
                            class="bg-green-600 hover:bg-green-700 text-white font-extrabold text-xl py-3 px-8 rounded-full transition-colors duration-200 shadow-lg shadow-green-600/50 disabled:bg-gray-600 disabled:shadow-none"
                            ${remaining > 0 ? 'disabled' : ''}
                        >
                            Generate All Bets
                        </button>
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }

        function renderResultsScreen() {
            const lotto = state.selectedLottery;
            const combinations = state.finalCombinations;
            const extraNumbers = state.extraNumbers;
            const baseCount = state.baseNumberCount;

            const html = `
                <div class="screen active" id="results-screen">
                    <button onclick="${lotto.extra ? "updateState({ screen: 'extraNumberSelection', finalCombinations: null })" : "updateState({ screen: 'numberSelection', finalCombinations: null })"}" class="text-yellow-400 hover:text-yellow-300 mb-6 font-semibold flex items-center gap-2">
                        <span class="icon-left w-5 h-5 transform rotate-180"></span> Back to Selection
                    </button>

                    <div class="text-center mb-10">
                        <h2 class="text-4xl font-bold text-green-400 mb-2 icon-check">Combinations Generated!</h2>
                        <p class="text-gray-400 text-lg">Your **${combinations.length} reduced bets** for ${lotto.name}.</p>
                        <div class="text-gray-500 text-sm mt-1">
                            <p>Base Numbers (${baseCount}): ${state.baseNumbers.join(', ')}</p>
                            ${lotto.extra ? `<p>${lotto.extra.name}: ${extraNumbers.join(', ')}</p>` : ''}
                        </div>
                    </div>

                    <div class="text-center mb-6">
                        <button 
                            onclick="exportToTxt()"
                            class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 icon-export flex items-center justify-center mx-auto"
                        >
                            Export Combinations to .TXT File
                        </button>
                    </div>

                    <div class="bg-gray-800/70 p-6 rounded-2xl border border-green-500/30 shadow-2xl">
                        <h3 class="text-2xl font-bold text-white mb-4">Your Final Bets:</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[500px] overflow-y-auto pr-2">
                            ${combinations.map((bet, index) => `
                                <div class="p-3 bg-gray-900 rounded-lg flex items-center justify-between border border-gray-700 hover:border-yellow-500 transition-colors duration-200">
                                    <span class="text-sm font-semibold text-yellow-300">#${index + 1}:</span>
                                    <div class="flex gap-2 items-center">
                                        ${bet.map(num => `
                                            <span class="w-10 h-10 flex items-center justify-center rounded-full bg-yellow-500 text-gray-900 font-bold shadow-md">${num}</span>
                                        `).join('')}
                                        
                                        ${extraNumbers.length > 0 ? `
                                            <span class="text-lg text-gray-400 ml-2">|</span>
                                            ${extraNumbers.map(num => `
                                                <span class="extra-ball-display">${num}</span>
                                            `).join('')}
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }


        // --- 4. FUNCI√ìN PRINCIPAL DE RENDERIZADO ---
        function renderApp() {
            switch (state.screen) {
                case 'continent':
                    renderContinentScreen();
                    break;
                case 'country':
                    renderCountryScreen();
                    break;
                case 'lottery':
                    renderLotteryScreen();
                    break;
                case 'combinations':
                    renderCombinationsScreen();
                    break;
                case 'numberSelection':
                    renderNumberSelectionScreen();
                    break;
                case 'extraNumberSelection':
                    renderExtraNumbersSelectionScreen();
                    break;
                case 'results':
                    renderResultsScreen();
                    break;
                // Nuevas pantallas del simulador
                case 'simLotterySelection':
                    renderSimLotterySelectionScreen();
                    break;
                case 'simBaseCountSelection':
                    renderSimBaseCountSelectionScreen();
                    break;
                case 'simNumberInput':
                    renderSimNumberInputScreen();
                    break;
                case 'simResults':
                    renderSimResultsScreen();
                    break;
                default:
                    renderContinentScreen();
            }
        }

        // 5. REGISTRO DEL SERVICE WORKER (Para la funcionalidad PWA)
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            // Nota: El service worker debe estar en la ra√≠z o en un scope que cubra todos los archivos.
            // Asumiendo que index.html y service-worker.js est√°n en la misma carpeta ra√≠z (/)
            navigator.serviceWorker.register('/service-worker.js')
              .then(registration => {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
              })
              .catch(error => {
                console.log('ServiceWorker registration failed: ', error);
              });
          });
        }

        // Inicializar la aplicaci√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', renderApp);

    </script>
</body>
</html>





